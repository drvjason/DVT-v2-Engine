# ─────────────────────────────────────────────────────────────────────────────
# RuleForge DVT Engine — Production Compose with Okta SSO
#
# Stack:
#   ruleforge-app  → Streamlit (internal only, never exposed directly)
#   oauth2-proxy   → Okta OIDC session enforcement
#   nginx          → TLS termination, HTTPS redirect, CSP headers, rate limiting
#   redis          → oauth2-proxy session store (multi-instance safe)
#
# Prerequisites:
#   1. Set all required secrets in .env.prod (see .env.example)
#   2. Place TLS cert at nginx/ssl/ruleforge.crt and nginx/ssl/ruleforge.key
#   3. Okta OIDC app registered with redirect URI:
#      https://<YOUR_DOMAIN>/oauth2/callback
# ─────────────────────────────────────────────────────────────────────────────
version: "3.9"

services:

  # ── Streamlit Application ─────────────────────────────────────────────────
  ruleforge-app:
    image: ${REGISTRY:-ghcr.io}/${IMAGE_REPO:-your-org/ruleforge}:${IMAGE_TAG:-latest}
    container_name: ruleforge-app
    restart: always
    # NOT exposed on host — only reachable via oauth2-proxy
    expose:
      - "8501"
    environment:
      - STREAMLIT_SERVER_PORT=8501
      - STREAMLIT_SERVER_ADDRESS=0.0.0.0
      - STREAMLIT_SERVER_HEADLESS=true
      - STREAMLIT_BROWSER_GATHER_USAGE_STATS=false
      - RULEFORGE_ENV=production
      # Injected at runtime from secrets vault — never hardcoded
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
    read_only: true
    tmpfs:
      - /tmp
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    networks:
      - ruleforge-internal
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8501')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 25s

  # ── Okta OIDC Enforcement (oauth2-proxy) ──────────────────────────────────
  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.6.0
    container_name: ruleforge-oauth2-proxy
    restart: always
    expose:
      - "4180"
    command:
      - --provider=oidc
      - --oidc-issuer-url=https://${OKTA_DOMAIN}/oauth2/default
      - --client-id=${OKTA_CLIENT_ID}
      - --client-secret=${OKTA_CLIENT_SECRET}
      - --redirect-url=https://${PUBLIC_DOMAIN}/oauth2/callback
      - --upstream=http://ruleforge-app:8501
      - --http-address=0.0.0.0:4180
      - --cookie-secret=${OAUTH2_COOKIE_SECRET}
      - --cookie-secure=true
      - --cookie-domain=${PUBLIC_DOMAIN}
      - --cookie-name=_ruleforge_session
      - --cookie-samesite=lax
      - --reverse-proxy=true
      - --session-store-type=redis
      - --redis-connection-url=redis://redis:6379
      # Restrict access to detection-engineering Okta group
      - --allowed-group=${OKTA_ALLOWED_GROUP:-detection-engineering}
      - --email-domain=*
      # Pass user identity headers to Streamlit for audit logging
      - --set-xauthrequest=true
      - --pass-access-token=false
      # Security
      - --skip-provider-button=true
      - --cookie-refresh=1h
      - --cookie-expire=8h
      - --silence-ping-logging=true
    read_only: true
    tmpfs:
      - /tmp
    security_opt:
      - no-new-privileges:true
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - ruleforge-internal
      - ruleforge-external

  # ── Redis Session Store ───────────────────────────────────────────────────
  redis:
    image: redis:7.2-alpine
    container_name: ruleforge-redis
    restart: always
    command: redis-server --save "" --appendonly no --maxmemory 256mb --maxmemory-policy allkeys-lru
    expose:
      - "6379"
    networks:
      - ruleforge-internal
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    security_opt:
      - no-new-privileges:true

  # ── nginx Reverse Proxy (TLS Termination) ─────────────────────────────────
  nginx:
    image: nginx:1.25-alpine
    container_name: ruleforge-nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    read_only: true
    tmpfs:
      - /var/cache/nginx
      - /var/log/nginx
      - /var/run
      - /tmp
    security_opt:
      - no-new-privileges:true
    depends_on:
      - oauth2-proxy
    networks:
      - ruleforge-external
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  ruleforge-internal:
    name: ruleforge-internal
    internal: true          # Not reachable from outside — only inter-container
  ruleforge-external:
    name: ruleforge-external
